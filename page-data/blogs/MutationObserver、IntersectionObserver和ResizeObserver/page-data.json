{
    "componentChunkName": "component---src-templates-blog-post-js",
    "path": "/blogs/MutationObserver、IntersectionObserver和ResizeObserver/",
    "result": {"data":{"site":{"siteMetadata":{"title":"张小伦的网络日志","description":"欢迎来到张小伦的网络日志 \n\t\t一个记录生活，分享心得的博客","menu":[{"id":"home","name":"首页","url":"/"},{"id":"category","name":"分类","url":"/categories"},{"id":"archive","name":"归档","url":"/archives"},{"id":"about","name":"关于我","url":"/about"}]}},"markdownRemark":{"id":"3be25867-f9aa-547c-997a-4cf93622625c","html":"<p>在之前的<a href=\"../%E4%BB%8Egetboundingclientrect%E5%88%B0intersection-observer/index.md\">从getboundingclientrect到intersection-observer</a>中提到了<code class=\"language-text\">Intersection Observer API</code>，今天趁热打铁，将现有的其他几个Observer API 一并整理，方便查阅</p>\n<h2>IntersectionObserver</h2>\n<p>字面翻译：交叉的观察者。即观察两个元素之间的交叉情况</p>\n<p>Web的传统位置计算机制依赖于显式查询DOM的状态。 其中一些会导致样式重新计算和布局(比如前文提到的<code class=\"language-text\">offsetHeight</code>, <code class=\"language-text\">offsetWidth</code> 和 <code class=\"language-text\">getBoundingClientRect()</code>)，并且经常需要JavaScript脚本需要轮询此信息，因此经常会让浏览器触发多余的重新计算和布局。在实际工作中，追踪或者判断DOM是否出现在客户端视图窗口中是一个很常见的操作。比如图片懒加载，滚动时元素进入的动画等等。一般来说可以通过监听滚动事件，使用<code class=\"language-text\">getBoundingClientRect()</code>来计算元素的位置。但正如前文所言，这存在性能问题。\n<code class=\"language-text\">Intersection Observer API</code> 就是为这而<a href=\"https://github.com/w3c/IntersectionObserver/blob/master/explainer.md\">设计</a>的，显着降低其CPU，GPU和能源消耗。</p>\n<h3>创建一个 IntersectionObserver</h3>\n<p>IntersectionObserver 的 API 非常简洁</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> observer <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IntersectionObserver</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">changes</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> change <span class=\"token keyword\">of</span> changes<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>change<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 观察目标元素的可见性变化</span>\nobserver<span class=\"token punctuation\">.</span><span class=\"token function\">observe</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 停止对一个元素的观察</span>\nobserver<span class=\"token punctuation\">.</span><span class=\"token function\">unobserve</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 停止对所有目标元素可见性变化的观察</span>\nobserver<span class=\"token punctuation\">.</span><span class=\"token function\">disconnect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3>callback</h3>\n<p>回调接收 IntersectionObserverEntry 对象和观察者的列表：</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">callback</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>entries<span class=\"token operator\">:</span> IntersectionObserverEntry<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> observer<span class=\"token operator\">:</span> IntersectionObserver<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> \n  entries<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>entry <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Each entry describes an intersection change for one observed</span>\n    <span class=\"token comment\">// target element:</span>\n    <span class=\"token comment\">//   entry.boundingClientRect</span>\n    <span class=\"token comment\">//   entry.intersectionRatio</span>\n    <span class=\"token comment\">//   entry.intersectionRect</span>\n    <span class=\"token comment\">//   entry.isIntersecting</span>\n    <span class=\"token comment\">//   entry.rootBounds</span>\n    <span class=\"token comment\">//   entry.target</span>\n    <span class=\"token comment\">//   entry.time</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">entries</code>是一个数组，和<code class=\"language-text\">threshold</code>对应。即使<code class=\"language-text\">threshold</code>输入的是一个数字，<code class=\"language-text\">entries</code>也会返回数组。下图是<code class=\"language-text\">IntersectionObserverEntry</code>的结构</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/2d9e4db5e60c060aa6af53a7319481c0/8b936/intersection-observer-api.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 94.30379746835443%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAIAAAAf7rriAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB+ElEQVQ4y5WSiWrrMBBF+//f1EKhpWtSCl0SQuImjndbix1ZkiWN5qGXkCZd6SAGC+nId+7MidY6jdN4FUfzKJq/LaKorKgxBoxBANQahditvkfn8CBOEFG1mswJWXeKaU4ZIQ2l1DCG1uJshhcXeHOD4zFeX+PrK6YpJgnGMcZxgMEAi9tsPRiDHwMg/A0AvQ/ZmKBlGLY5wG5wPGnLfFASED2A38bRKx+2e9neQZ30LQf8YwTYDqarlep0mZV5VmcJ7YXX0uHWMymDVVIGqX0fnJMSOUdrAyyZYgtGFoyu2WpVzKbFcl5t1gQZw+kURyO8uwv5/h6fnoJno1GwkNJdzfSNFYl2R8L9d6UeyQbjeNzm6aB62N//mvL+8GAH18uOM/dFk6x9b9Wn9/7LNratpOwGSjltqBDCK4VnZ/j8jC8vobzz81DweIyTCdb1ESyZJDNKYhZFRZFWIs+xafDyEh8e8PERr67CkJ2e4u1t+J5M9hICrDcDmZFs2RHSSdlLIUKTvEdKsShCV6QMzvf9V4ZZoCvelAZ+HZPPhjntyJI3lXH2+N6hT98ZBgAd0cZ4C866sP4wnqqTPBOiFs1yTctq0zShPVWFef47LLmkiSiTvlxzTtsNZy3nirHg088wAEiuFB9Ev2lobawZjLHWwo+DuYX/AZPsTBTZTNhlAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"intersection-observer-api.png\"\n        title=\"intersection-observer-api.png\"\n        src=\"/static/2d9e4db5e60c060aa6af53a7319481c0/f058b/intersection-observer-api.png\"\n        srcset=\"/static/2d9e4db5e60c060aa6af53a7319481c0/c26ae/intersection-observer-api.png 158w,\n/static/2d9e4db5e60c060aa6af53a7319481c0/6bdcf/intersection-observer-api.png 315w,\n/static/2d9e4db5e60c060aa6af53a7319481c0/f058b/intersection-observer-api.png 630w,\n/static/2d9e4db5e60c060aa6af53a7319481c0/40601/intersection-observer-api.png 945w,\n/static/2d9e4db5e60c060aa6af53a7319481c0/78612/intersection-observer-api.png 1260w,\n/static/2d9e4db5e60c060aa6af53a7319481c0/8b936/intersection-observer-api.png 1368w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>下图可以清晰的看出<code class=\"language-text\">intersectionRadio</code>的意义</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/9bc316a320eafbfc56bd4b26454cab96/cc155/intersectratio.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 98.73417721518987%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAAEr0lEQVQ4y42Ua08TaRiGR7rxi9mP/IT9B6u7RrPxEAJyKqX0RIEoSlRQQDCFCkqhWBtaSEgsXcgWbIusca3Qw5QeKEVoS2em7ZSKa4if/Eb8C2PfezODEk02m53kyv3cM5N7njfPOy9FURS1l07LSrkcxefzjtyrV2CWlgTW4yGsxwMJt/sIjwfMN7WE10uYxcVygabBv3+vFvOogt8vK21tUXsM43hz5w5iDQ1CvLmZxJubEVcqsdHSgg2VCnGFAgm1WvJiLaFUkmh1dTltNuPdp09fAoNBGR+NUnwm42AePwY7PCxwJhNhR0fBPnwIzmRCwWJBZnAQjNGIVG8v4hoNNlpbsaHXk1hTUzljtWL/8FBNOZ1OqrC6KttLJqliNuvY6u5GtLZWEL983EVT03FHMbn8iMbGI5qayPrly+XU+PhRh2JgKZ2WvcvnqRLPP82/eAF2YUHgXC7CuVz4TxYXRQg7P1/mg0GUPnxQSYF/ZzKy4u4uxXOcM+f1gnn6VGCdTsI6nfiOuTkwc3PHKuF0kuzsbLng84E/ONBSNpvtxIDFQtlmZn6JhELrL3t78Uyp/OzRaolHq4Vbq4WoHo0GHp0Oy3o9vK2tki63tWG5o4O4W1qI32xGIBZzUgCkwVjt9l8LmYwz/OAB1m7eFPx375K17m4EenoQ7O8HPTgI3/Xr8HV1IdDXh+ctLfAqFFhWKslSTQ2JmM1IF4sPqbNnz1aIgU/s9tNcOr0QuHcPL/V64fWNG8R37Rp8nZ14dfUqVru68Fd7O/5Uq/FS7Ewuh6euDt7GRrJ46RIJj40hVSw+omQy2U9SoNV6mi8U5nPRKLKrq0LW7ydZvx/HrK2BCQTABIOSsqEQWJoWIUwgQPZ2dpDc3n5EVVRU/PbjqVOnTCbTr3vF4vwblwtRq1WIT0+TuN2O2DfEp6ch3bPZJJX8zAyJWq0kvbKCrVRKCjx3UiarHDIaz+/x/O+vb9+Gu6pK8DY0EG99PUSWGxsl3LW10jKfKxRSvVRVhWc1NeSP8+dJ0GDADsdJgWfEJU/Z7T/nWXYhNjmJ8MCAEBkZIetDQ4gYjYiOjGBjfBzBvj6Ig0pMTMDf3S0OBCtqNfHU15N1kwnbLPuIqqysPCkGTlosZ/h8fsF36xZcFy8K7tpa4r5yBc9EamokdX+tq6ulWqKujrguXCCh4eGjQPESt87k5OTp/bdvHXwyiVw4LOQiEZKLRPA/IBxNk1IqhTc7Ow8og8FwQtPZSU1NTZ3bSiZ9sfl5BJ88+UzbbISemsK/EfrW22wkaLGQhNuNUCQyK/16Xzb3iZ3t7ZXYwAACCsXnkFZLQhoNROjWVoR0OgRFr9OB1usRVKulZ+J7Abm8vDE2hiTD3JUCmUjkh93NTWqf52dZ8fi6f1/IjY4SbngYnNGI3MgICuPj2O3vR7qnB+zQEDbFo0ulQkKrJfGGhnJmYgIHh4cKKXA/mZQdlErU22LRkTIYkFCphGRHB0m2tSHZ3o5NvV5S0YtBok9otUhoNEjodCQul5czZjP2P37USEPhsllZjuMohmEcTDyOLE0L2XCYZMNhscZ3+pX1dTBHkCxNl9nNTewyjPofpgrvWq7q9LwAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"intersectratio.png\"\n        title=\"intersectratio.png\"\n        src=\"/static/9bc316a320eafbfc56bd4b26454cab96/f058b/intersectratio.png\"\n        srcset=\"/static/9bc316a320eafbfc56bd4b26454cab96/c26ae/intersectratio.png 158w,\n/static/9bc316a320eafbfc56bd4b26454cab96/6bdcf/intersectratio.png 315w,\n/static/9bc316a320eafbfc56bd4b26454cab96/f058b/intersectratio.png 630w,\n/static/9bc316a320eafbfc56bd4b26454cab96/cc155/intersectratio.png 886w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p><code class=\"language-text\">IntersectionObservers</code> 是异步传递数据，回调函数中的代码将在主线程中运行。 规范中提到<code class=\"language-text\">IntersectionObserver</code>实现应使用<code class=\"language-text\">requestIdleCallback（）</code>。 这意味着对回调函数的执行是低优先级的，将在客户端空闲时间进行。 这是有意为之。</p>\n<h3>options</h3>\n<p>传递到IntersectionObserver()构造函数的 options 对象包含以下字段：</p>\n<ul>\n<li><strong>root</strong>\n<ul>\n<li>指定根(root)元素，用于检查目标的可见性。必须是目标元素的父级元素。</li>\n<li>如果未指定或者为null，则默认为浏览器视窗。</li>\n</ul>\n</li>\n<li><strong>rootMargin</strong>\n<ul>\n<li>根元素的外边距。类似于css中的 margin 属性，比如 “10px 20px 30px 40px” (top, right, bottom, left)。</li>\n<li>如果有指定root参数，则rootMargin也可以使用百分比来取值。该属性值是用作root元素和target发生交集时候的计算交集的区域范围，使用该属性可以控制root元素每一边的收缩或者扩张。</li>\n<li>默认值为0。</li>\n</ul>\n</li>\n<li><strong>threshold</strong>\n<ul>\n<li>可以是一个数字也可以是一个数字数组。目标元素和根元素相交程度达到该值的时候IntersectionObserver注册的回调函数将会被执行。</li>\n<li>如果你只是想要探测当target元素的在root元素中的可见性超过50%的时候，你可以指定该属性值为0.5。</li>\n<li>如果你想要target元素在root元素的可见程度每多25%就执行一次回调，那么你可以指定一个数组[0, 0.25, 0.5, 0.75, 1]。</li>\n<li>默认值是0(意味着只要有一个target像素出现在root元素中，回调函数将会被执行)。</li>\n<li>该值为1.0含义是当target完全出现在root元素中时候 回调才会被执行。</li>\n</ul>\n</li>\n</ul>\n<p><strong>注意：</strong></p>\n<ol>\n<li>如果使用默认的<code class=\"language-text\">options</code>，目标元素部分进入视图窗口和完全离开视图窗口时，都会触发一次回调函数</li>\n<li>如果你想同时观察多个元素，尽可能地在一个<code class=\"language-text\">IntersectionObserver</code>的实例上调用多次<code class=\"language-text\">observer</code>方法</li>\n</ol>\n<h3>常用场景</h3>\n<h4>元素的可见性监听</h4>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token comment\">&lt;!-- 网页中嵌入的广告 --></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>iframe</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>theAd<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>iframe</span><span class=\"token punctuation\">></span></span>\n<span class=\"token comment\">&lt;!-- 嵌入的脚本 --></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>//cdn.example.com/ads.js<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">async</span><span class=\"token punctuation\">></span></span><span class=\"token script\"></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// ads.js</span>\n\n<span class=\"token comment\">// 上报信息</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">logImpressionToServer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">/* ... */</span> <span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// 判断是否可见</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">isVisible</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">boundingClientRect<span class=\"token punctuation\">,</span> intersectionRect</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>intersectionRect<span class=\"token punctuation\">.</span>width <span class=\"token operator\">*</span> intersectionRect<span class=\"token punctuation\">.</span>height<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span>\n          <span class=\"token punctuation\">(</span>boundingClientRect<span class=\"token punctuation\">.</span>width <span class=\"token operator\">*</span> boundingClientRect<span class=\"token punctuation\">.</span>height<span class=\"token punctuation\">)</span> <span class=\"token operator\">>=</span> <span class=\"token number\">0.5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">visibleTimerCallback</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">element<span class=\"token punctuation\">,</span> observer</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">delete</span> element<span class=\"token punctuation\">.</span>visibleTimeout<span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">processChanges</span><span class=\"token punctuation\">(</span>observer<span class=\"token punctuation\">.</span><span class=\"token function\">takeRecords</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'isVisible'</span> <span class=\"token keyword\">in</span> element<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">delete</span> element<span class=\"token punctuation\">.</span>isVisible<span class=\"token punctuation\">;</span>\n    <span class=\"token function\">logImpressionToServer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    observer<span class=\"token punctuation\">.</span><span class=\"token function\">unobserve</span><span class=\"token punctuation\">(</span>element<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// 交叉时的回调函数</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">processChanges</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">changes</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  changes<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">changeRecord</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> element <span class=\"token operator\">=</span> changeRecord<span class=\"token punctuation\">.</span>target<span class=\"token punctuation\">;</span>\n    element<span class=\"token punctuation\">.</span>isVisible <span class=\"token operator\">=</span> <span class=\"token function\">isVisible</span><span class=\"token punctuation\">(</span>changeRecord<span class=\"token punctuation\">.</span>boundingClientRect<span class=\"token punctuation\">,</span> changeRecord<span class=\"token punctuation\">.</span>intersectionRect<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'isVisible'</span> <span class=\"token keyword\">in</span> element<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 显示</span>\n      element<span class=\"token punctuation\">.</span>visibleTimeout <span class=\"token operator\">=</span> <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span>visibleTimerCallback<span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">,</span> element<span class=\"token punctuation\">,</span> observer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 隐藏</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'visibleTimeout'</span> <span class=\"token keyword\">in</span> element<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">clearTimeout</span><span class=\"token punctuation\">(</span>element<span class=\"token punctuation\">.</span>visibleTimeout<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">delete</span> element<span class=\"token punctuation\">.</span>visibleTimeout<span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> observer <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IntersectionObserver</span><span class=\"token punctuation\">(</span>\n  processChanges<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span> threshold<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">0.5</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">}</span> \n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> theAd <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">querySelector</span><span class=\"token punctuation\">(</span><span class=\"token string\">'#theAd'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nobserver<span class=\"token punctuation\">.</span><span class=\"token function\">observe</span><span class=\"token punctuation\">(</span>theAd<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>乍看之下好像需要编写更多复杂代码，但是对比传统的方式，这种方式有其优点</p>\n<ol>\n<li>无需监听scroll事件</li>\n<li>没有频繁的同步计算布局，没有插件依赖，只使用了一个定时器来记录状态</li>\n</ol>\n<h4>数据滚动</h4>\n<p>许多系统使用数据绑定列表来管理其视图内内容，可以通过回收DOM的方式保持内存和布局效。率。通常我们在渲染分页加载的列表数据的时候，为了避免滚动的时候出现卡顿感，会一次加载好几页的数据，但是实际上需要渲染的数据是总数据的子集。并且随着页码的加大，这个列表中的DOM会越来越多。我们可以在列表元素上使用 <code class=\"language-text\">IntersectionObserver</code>，来通知系统何时加载数据，何时回收DOM</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>style</span><span class=\"token punctuation\">></span></span><span class=\"token style\"><span class=\"token language-css\">\n  <span class=\"token selector\">.container</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">overflow</span><span class=\"token punctuation\">:</span> auto<span class=\"token punctuation\">;</span>\n    <span class=\"token property\">width</span><span class=\"token punctuation\">:</span> 10em<span class=\"token punctuation\">;</span>\n    <span class=\"token property\">height</span><span class=\"token punctuation\">:</span> 30em<span class=\"token punctuation\">;</span>\n    <span class=\"token property\">position</span><span class=\"token punctuation\">:</span> relative<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token selector\">.inner-scroll-surface</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">position</span><span class=\"token punctuation\">:</span> absolute<span class=\"token punctuation\">;</span>\n    <span class=\"token property\">left</span><span class=\"token punctuation\">:</span> 0px<span class=\"token punctuation\">;</span>\n    <span class=\"token property\">top</span><span class=\"token punctuation\">:</span> 0px<span class=\"token punctuation\">;</span>\n    <span class=\"token property\">width</span><span class=\"token punctuation\">:</span> 100%<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">/* proportional to the # of expected items in the list */</span>\n    <span class=\"token property\">height</span><span class=\"token punctuation\">:</span> 1000px<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token selector\">.scroll-item</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">position</span><span class=\"token punctuation\">:</span> absolute<span class=\"token punctuation\">;</span>\n    <span class=\"token property\">height</span><span class=\"token punctuation\">:</span> 2em<span class=\"token punctuation\">;</span>\n    <span class=\"token property\">left</span><span class=\"token punctuation\">:</span> 0px<span class=\"token punctuation\">;</span>\n    <span class=\"token property\">right</span><span class=\"token punctuation\">:</span> 0px<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n</span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>style</span><span class=\"token punctuation\">></span></span>\n\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>container<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>inner-scroll-surface<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>scroll-item<span class=\"token punctuation\">\"</span></span> <span class=\"token special-attr\"><span class=\"token attr-name\">style</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span><span class=\"token value css language-css\"><span class=\"token property\">top</span><span class=\"token punctuation\">:</span> 0em<span class=\"token punctuation\">;</span></span><span class=\"token punctuation\">\"</span></span></span><span class=\"token punctuation\">></span></span>item 1<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>scroll-item<span class=\"token punctuation\">\"</span></span> <span class=\"token special-attr\"><span class=\"token attr-name\">style</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span><span class=\"token value css language-css\"><span class=\"token property\">top</span><span class=\"token punctuation\">:</span> 2em<span class=\"token punctuation\">;</span></span><span class=\"token punctuation\">\"</span></span></span><span class=\"token punctuation\">></span></span>item 2<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>scroll-item<span class=\"token punctuation\">\"</span></span> <span class=\"token special-attr\"><span class=\"token attr-name\">style</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span><span class=\"token value css language-css\"><span class=\"token property\">top</span><span class=\"token punctuation\">:</span> 4em<span class=\"token punctuation\">;</span></span><span class=\"token punctuation\">\"</span></span></span><span class=\"token punctuation\">></span></span>item 3<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token comment\">&lt;!-- ... --></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>As the user moves the container, the children can be observed and as they cross the threshold of the scrollable area, a manager can recycle them and fill them with new data instead of needing to re-create the items from scratch.</p>\n<p>当用户滚动列表时，列表元素经过预先设定的阈值时，可以执行对应的处理逻辑</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">query</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">selector</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> Array<span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span>document<span class=\"token punctuation\">.</span><span class=\"token function\">querySelectorAll</span><span class=\"token punctuation\">(</span>selector<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> opts <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> \n    root<span class=\"token operator\">:</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">querySelector</span><span class=\"token punctuation\">(</span><span class=\"token string\">\".container\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    rootMargin<span class=\"token operator\">:</span> <span class=\"token string\">\"500px 0px\"</span> \n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> observer <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IntersectionObserver</span><span class=\"token punctuation\">(</span>manageItemPositionChanges<span class=\"token punctuation\">,</span> opts<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">query</span><span class=\"token punctuation\">(</span><span class=\"token string\">\".inner-scroll-surface > .scroll-item\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">scrollItem</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      observer<span class=\"token punctuation\">.</span><span class=\"token function\">observe</span><span class=\"token punctuation\">(</span>scrollItem<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">manageItemPositionChanges</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">changes</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4>延迟加载</h4>\n<p>使用<code class=\"language-text\">IntersectionObserver</code>轻松实现懒加载</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>lazy-loaded<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>template</span><span class=\"token punctuation\">></span></span>\n    ...\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>template</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">query</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">selector</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> Array<span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span>document<span class=\"token punctuation\">.</span><span class=\"token function\">querySelectorAll</span><span class=\"token punctuation\">(</span>selector<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">var</span> observer <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IntersectionObserver</span><span class=\"token punctuation\">(</span>\n  <span class=\"token comment\">// 预先加载在视窗可见区域高度两倍以内的元素</span>\n  <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">changes</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    changes<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">change</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">var</span> container <span class=\"token operator\">=</span> change<span class=\"token punctuation\">.</span>target<span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">var</span> content <span class=\"token operator\">=</span> container<span class=\"token punctuation\">.</span><span class=\"token function\">querySelector</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"template\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>content<span class=\"token punctuation\">;</span>\n      container<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>content<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      observer<span class=\"token punctuation\">.</span><span class=\"token function\">unobserve</span><span class=\"token punctuation\">(</span>container<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span> rootMargin<span class=\"token operator\">:</span> <span class=\"token string\">\"200% 0%\"</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">query</span><span class=\"token punctuation\">(</span><span class=\"token string\">\".lazy-loaded\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">item</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  observer<span class=\"token punctuation\">.</span><span class=\"token function\">observe</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2>MutationObserver</h2>\n<p>在web应用中，DOM操作是相当频繁的。在过去有一段时间，公认有效的一种方式是使用<code class=\"language-text\">Mutation Events</code>，不过这个特性在API的设计中有缺陷，为DOM添加 mutation 监听器反而会进一步降低修改DOM文档的性能（慢1.5 - 7倍）。而且 移除监听器不会减少性能的消耗。目前已经被废弃了。具体原因可以查看<a href=\"https://lists.w3.org/Archives/Public/public-webapps/2011JulSep/0779.html\">DOM Mutation Events Replacement: The Story So Far / Existing Points of Consensus</a>。简单来说以下三点原因：</p>\n<ol>\n<li>冗余。因为经常触发</li>\n<li>慢。因为事件传播所以慢，同时还阻止了一些UA的自我优化</li>\n<li>容易crash。</li>\n</ol>\n<p>W3C提出了<code class=\"language-text\">MutationObserver</code>来代替<code class=\"language-text\">Mutation Events</code>。</p>\n<h3>创建一个 MutationObserver</h3>\n<p><code class=\"language-text\">MutationObserver</code> 可以监听DOM节点的变化，属性的变化，它最基本的语法如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">const</span> targetNode <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">querySelector</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"#someElement\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> observerOptions <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  childList<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\">// 观察目标子节点的变化，是否有添加或者删除</span>\n  attributes<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 观察属性变动</span>\n  subtree<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span>     <span class=\"token comment\">// 观察后代节点，默认为 false</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> observer <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MutationObserver</span><span class=\"token punctuation\">(</span>callback<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span>records<span class=\"token operator\">:</span> mutationRecord<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> observer<span class=\"token operator\">:</span> MutationObserver<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span>\nobserver<span class=\"token punctuation\">.</span><span class=\"token function\">observe</span><span class=\"token punctuation\">(</span>targetNode<span class=\"token punctuation\">,</span> observerOptions<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// ...</span>\n\nobserver<span class=\"token punctuation\">.</span><span class=\"token function\">disconnect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// 停止观察变动。 可以重用观察者。所有已经检测到但是尚未向观察者报告的变动都会被丢弃</span></code></pre></div>\n<p>使用选择器来获取目标节点树。 <code class=\"language-text\">observerOptions</code> 中设定了观察者的选项，通过设定 childList 和 attributes 为 true 来获取所需信息，表示同时观察目标节点树的childList和attributes的变化。</p>\n<h3>callback</h3>\n<p>每当被指定的节点或子树以及配置项有 DOM 变动时，callback会被异步调用。这个函数有两个参数：一个是描述所有被触发改动的 <a href=\"https://developer.mozilla.org/zh-CN/docs/Web/API/MutationRecord\"><code class=\"language-text\">MutationRecord</code></a> 对象数组，另一个是调用该函数的MutationObserver 对象。比如：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">mutationRecords<span class=\"token punctuation\">,</span> observer</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  mutationRecords<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">mutation</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">switch</span><span class=\"token punctuation\">(</span>mutation<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">case</span> <span class=\"token string\">'childList'</span><span class=\"token operator\">:</span>\n        <span class=\"token comment\">/* 从树上添加或移除一个或更多的子节点；参见 mutation.addedNodes 与\n           mutation.removedNodes */</span>\n        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">case</span> <span class=\"token string\">'attributes'</span><span class=\"token operator\">:</span>\n        <span class=\"token comment\">/* mutation.target 中某节点的一个属性值被更改；该属性名称在 mutation.attributeName 中，\n           该属性之前的值为 mutation.oldValue */</span>\n        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>:::info\ncallback 的函数签名和 <code class=\"language-text\">IntersectionObserver</code> 很相似。其实这些 Observer 的callback 的函数签名都是相似的\n:::</p>\n<p>之后指定目标节点与记录选项，我们开始观察使用 <code class=\"language-text\">observe()</code> 指定的 DOM 节点。</p>\n<p>从现在开始直到调用 <code class=\"language-text\">disconnect()</code> ，每次以 targetNode 为根节点的 DOM 树添加或移除元素时，以及这些元素的任意属性改变时，<code class=\"language-text\">callback()</code> 都会被调用。</p>\n<h3>options</h3>\n<p><code class=\"language-text\">observer(target, options)</code> 中的 <code class=\"language-text\">options</code> 是一个<code class=\"language-text\">MutationObserverInit</code>对象，描述了 MutationObserver 的配置。当调用 <code class=\"language-text\">observe()</code> 方法时，<code class=\"language-text\">childList</code>，<code class=\"language-text\">attributes</code> 或者 <code class=\"language-text\">characterData</code> 三个属性之中，至少有一个必须为 <code class=\"language-text\">true</code>，否则会抛出 <code class=\"language-text\">TypeError</code> 异常。</p>\n<table>\n<thead>\n<tr>\n<th>参数名</th>\n<th>描述</th>\n<th>是否可选</th>\n<th>默认值</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>childList</td>\n<td>设为 <code class=\"language-text\">true</code> 时，监视目标节点（如果 subtree 为 true，则包含子孙节点）添加或删除新的子节点。</td>\n<td>可选</td>\n<td>false</td>\n</tr>\n<tr>\n<td>attributes</td>\n<td>设为 <code class=\"language-text\">true</code> 时，观察受监视元素的属性值变更</td>\n<td>可选</td>\n<td>false</td>\n</tr>\n<tr>\n<td>characterData</td>\n<td>设为 <code class=\"language-text\">true</code> 时，监视指定目标节点或子节点树中节点所包含的字符数据的变化</td>\n<td>可选</td>\n<td>-</td>\n</tr>\n<tr>\n<td>attributeFilter</td>\n<td>要监视的特定属性名称的数组。如果未包含此属性，则对所有属性的更改都会触发变动通知</td>\n<td>可选</td>\n<td>-</td>\n</tr>\n<tr>\n<td>attributeOldValue</td>\n<td>当监视节点的属性改动时，将此属性设为 true 将记录任何有改动的属性的上一个值</td>\n<td>可选</td>\n<td>-</td>\n</tr>\n<tr>\n<td>characterDataOldValue</td>\n<td>设为 <code class=\"language-text\">true</code>时， 受监视节点的文本(text)发生更改时记录节点文本的先前值</td>\n<td>可选</td>\n<td>-</td>\n</tr>\n<tr>\n<td>subtree</td>\n<td>设为 <code class=\"language-text\">true</code> 时将监视范围扩展至目标节点整个节点树中的所有节点。MutationObserverInit 的其他值也会作用于此子树下的所有节点，而不仅仅只作用于目标节点。</td>\n<td>可选</td>\n<td>false</td>\n</tr>\n</tbody>\n</table>\n<h3>takeRecords()</h3>\n<p>返回<strong>已检测到但尚未由观察者的回调函数处理的所有匹配DOM更改的列表，使变更队列保持为空</strong>。 最常见的使用场景是：在断开观察者之前立即获取所有未处理的更改记录，以便在停止观察者时可以处理任何未处理的更改。比如：</p>\n<div class=\"gatsby-highlight\" data-language=\"diff\"><pre class=\"language-diff\"><code class=\"language-diff\">var targetNode = document.querySelector(\"#someElement\");\nvar observerOptions = {\n<span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span> childList: true,\n<span class=\"token prefix unchanged\"> </span> attributes: true\n</span>}\n\nvar observer = new MutationObserver(callback);\nobserver.observe(targetNode, observerOptions);\n\n// 这里做了一些事情\n// ...\n<span class=\"token inserted-sign inserted\"><span class=\"token prefix inserted\">+</span>// 开始处理尚未结束的变更\n<span class=\"token prefix inserted\">+</span>var mutations = observer.takeRecords();\n</span>\n<span class=\"token inserted-sign inserted\"><span class=\"token prefix inserted\">+</span>if (mutations) {\n<span class=\"token prefix inserted\">+</span>  callback(mutations);\n<span class=\"token prefix inserted\">+</span>}\n</span>\nobserver.disconnect();</code></pre></div>\n<h2>Resize Observer</h2>\n<p>这个API和其他的Observer类似，他可以用来观察元素大小的变化。onresize事件则只能有window来触发。大部分使用场景可能是在视窗大小发生变化，或者在移动设备上屏幕旋转时，监听页面元素尺寸的变化。在resizeObserver出现之前，只能使用 <code class=\"language-text\">window.resize</code> 事件来见视窗的大小变化。这种方式稍不留神就容易因为频繁触发resize事件而出现性能问题，从另一个层面来说，<code class=\"language-text\">resize</code>有点“浪费资源”，因为我们只能通过视窗的变化来计算目标元素的变化。</p>\n<p>现如今重Web端的SPA页面中，经常需要动态地添加或者删除DOM，频繁修改父元素的尺寸，这种case只有Resize Observer API能够帮我们。</p>\n<p>除了监听元素大小变化之外，还有几个有意思的特性：</p>\n<ol>\n<li>目标元素被插入或者从DOM中移除时会触发观察</li>\n<li>目标元素display修改为<code class=\"language-text\">none</code>时会触发观察</li>\n<li>非替换元素(<a href=\"https://developer.mozilla.org/zh-CN/docs/Web/CSS/Replaced_element\">link</a>)不会触发观察</li>\n<li>tranforms不会触发观察</li>\n<li>如果元素被渲染了时尺寸不是0，0，也会触发观察</li>\n</ol>\n<h3>创建一个 ResizeObserver</h3>\n<p>与<code class=\"language-text\">intersectionObserver</code>和<code class=\"language-text\">MutationObserver</code>不同，ResizeObserver的构造函数只需要一个<code class=\"language-text\">callback</code>参数。但是监听和取消监听的方法类似</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">callbacl</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">entries</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> myObserver <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ResizeObserver</span><span class=\"token punctuation\">(</span>callback<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> someEl <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">querySelector</span><span class=\"token punctuation\">(</span><span class=\"token string\">'.some-element'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> someOtherEl <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">querySelector</span><span class=\"token punctuation\">(</span><span class=\"token string\">'.some-other-element'</span><span class=\"token punctuation\">)</span>\n\nmyObserver<span class=\"token punctuation\">.</span><span class=\"token function\">observe</span><span class=\"token punctuation\">(</span>someEl<span class=\"token punctuation\">)</span>\nmyObserver<span class=\"token punctuation\">.</span><span class=\"token function\">observe</span><span class=\"token punctuation\">(</span>someOtherEl<span class=\"token punctuation\">)</span></code></pre></div>\n<h3>callback</h3>\n<p>当观察的目标元素尺寸发生变化时触发回调函数，参数是一个<code class=\"language-text\">ResizeObserverEntry</code>对象数组。ResizeObserverEntry的接口如下</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">interface</span> <span class=\"token class-name\">ResizeObserverEntry</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">readonly</span> attribute Element target<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">readonly</span> attribute DOMRectReadOnly contentRect<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">readonly</span> attribute sequence<span class=\"token operator\">&lt;</span>ResizeObserverSize<span class=\"token operator\">></span> borderBoxSize<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">readonly</span> attribute sequence<span class=\"token operator\">&lt;</span>ResizeObserverSize<span class=\"token operator\">></span> contentBoxSize<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">readonly</span> attribute sequence<span class=\"token operator\">&lt;</span>ResizeObserverSize<span class=\"token operator\">></span> devicePixelContentBoxSize<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">contentRect</code> 是 ResizeObserver API 孵化阶段时的产物，考虑到兼容性问题暂时保留，在未来可能会被废弃。</p>\n<p>当观察的目标元素尺寸发生变化时触发回调函数，参数是一个<code class=\"language-text\">ResizeObserverEntry</code>对象数组。<code class=\"language-text\">ResizeObserverEntry</code>对象包含两个属性：<code class=\"language-text\">contentRect</code>，<code class=\"language-text\">target</code>。<strong>target</strong>是被观察的目标对象。<strong>contentRect</strong>是<code class=\"language-text\">DOMRectReadOnly</code>的引用，包含 <code class=\"language-text\">width</code>, <code class=\"language-text\">height</code>, <code class=\"language-text\">x</code>, <code class=\"language-text\">y</code>, <code class=\"language-text\">top</code>, <code class=\"language-text\">right</code>, <code class=\"language-text\">bottom</code> 和 <code class=\"language-text\">left</code>。和<code class=\"language-text\">Element.getBoundingClientRect()</code>返回的数据不同，<code class=\"language-text\">contentRect</code>的<code class=\"language-text\">width</code>和<code class=\"language-text\">height</code>不包含<code class=\"language-text\">padding</code>，<code class=\"language-text\">contentRect.top</code>是元素的<code class=\"language-text\">padding-top</code>，<code class=\"language-text\">contentRect.left</code>是元素的<code class=\"language-text\">padding-left</code>。</p>\n<p>比如在元素调整大小时，其内部文本显示为尺寸大小，代码如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> resizeObserver <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ResizeObserver</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">entries</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> entry <span class=\"token keyword\">of</span> entries<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> boxEl <span class=\"token operator\">=</span> entry<span class=\"token punctuation\">.</span>target\n    <span class=\"token keyword\">const</span> dimensions <span class=\"token operator\">=</span> entry<span class=\"token punctuation\">.</span>contentRect\n\n    boxEl<span class=\"token punctuation\">.</span>textContent <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>dimensions<span class=\"token punctuation\">.</span>width<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> x </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>dimensions<span class=\"token punctuation\">.</span>height<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\nresizeObserver<span class=\"token punctuation\">.</span><span class=\"token function\">observe</span><span class=\"token punctuation\">(</span>document<span class=\"token punctuation\">.</span><span class=\"token function\">querySelector</span><span class=\"token punctuation\">(</span><span class=\"token string\">'.box:nth-child(2)'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h3>observe(target, options)</h3>\n<p>ResizeObserver实例的observe方法还有第二个参数<code class=\"language-text\">options</code>。不过暂时处于草案阶段，浏览器还不支持第二个参数。</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">enum</span> ResizeObserverBoxOptions <span class=\"token punctuation\">{</span>\n  <span class=\"token string\">\"border-box\"</span><span class=\"token punctuation\">,</span> \n  <span class=\"token string\">\"content-box\"</span><span class=\"token punctuation\">,</span> \n  <span class=\"token string\">\"device-pixel-content-box\"</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>可以控制Observer观察不同的CSS尺寸：</p>\n<ul>\n<li><strong>border-box</strong> : box-border。返回的尺寸包含padding和border</li>\n<li><strong>content-box</strong> : content-boder。返回的尺寸不包含padding和border。默认值</li>\n<li><strong>device-pixel-content-box</strong> : 返回的尺寸是未经缩放的，和设备像素相关的大小，一定是一个整数。</li>\n</ul>\n<h3>常用场景</h3>\n<h4>iframe的大小变化</h4>\n<p>iframe 可以检测到大小的变化然后通知给父窗口</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">let</span> ro <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ResizeObserver</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">entries</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> idealSize <span class=\"token operator\">=</span> <span class=\"token function\">computeIdealSize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  window<span class=\"token punctuation\">.</span>parent<span class=\"token punctuation\">.</span><span class=\"token function\">postMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    name<span class=\"token operator\">:</span> <span class=\"token string\">\"iframeResize\"</span><span class=\"token punctuation\">,</span>\n    width<span class=\"token operator\">:</span> idealSize<span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">,</span>\n    height<span class=\"token operator\">:</span> idealSize<span class=\"token punctuation\">.</span>height\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'*'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nro<span class=\"token punctuation\">.</span><span class=\"token function\">observe</span><span class=\"token punctuation\">(</span>document<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// window上监听message事件</span>\nwindow<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"message\"</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">ev</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ev<span class=\"token punctuation\">.</span>data <span class=\"token operator\">&amp;&amp;</span> ev<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>name <span class=\"token operator\">==</span> <span class=\"token string\">\"iframeResize\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> iframe <span class=\"token operator\">=</span> <span class=\"token function\">findEventSourceIframe</span><span class=\"token punctuation\">(</span>ev<span class=\"token punctuation\">.</span>source<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>iframe<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      iframe<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>width <span class=\"token operator\">=</span> ev<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>width <span class=\"token operator\">+</span> <span class=\"token string\">\"px\"</span><span class=\"token punctuation\">;</span>\n      iframe<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>height <span class=\"token operator\">=</span> ev<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>height <span class=\"token operator\">+</span> <span class=\"token string\">\"px\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h4>聊天窗口自动滚动到底部</h4>\n<p>在聊天窗口中，最新的消息在底部。为了防止浏览器自动滚动到顶部，当收到新消息时需要将滚动的位置保持在最底部。当窗口自动变化的时候也要保证能够</p>\n<div class=\"gatsby-highlight\" data-language=\"css\"><pre class=\"language-css\"><code class=\"language-css\"><span class=\"token selector\">.chat</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">overflow</span><span class=\"token punctuation\">:</span> scroll<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>chat<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>  <span class=\"token comment\">&lt;!-- chat has the scrollbar --></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>chat-text<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span> <span class=\"token comment\">&lt;!-- chat-text contains chat text --></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span>jack: hi <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span>jill: hi <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n&lt;/div</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">let</span> ro <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ResizeObserver</span><span class=\"token punctuation\">(</span> <span class=\"token parameter\">entries</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> e <span class=\"token keyword\">of</span> entries<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> chat <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>target<span class=\"token punctuation\">.</span>parentNode<span class=\"token punctuation\">;</span>\n    chat<span class=\"token punctuation\">.</span>scrollTop <span class=\"token operator\">=</span> chat<span class=\"token punctuation\">.</span>scrollHeight <span class=\"token operator\">-</span> chat<span class=\"token punctuation\">.</span>clientHeight<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nro<span class=\"token punctuation\">.</span><span class=\"token function\">observe</span><span class=\"token punctuation\">(</span>document<span class=\"token punctuation\">.</span><span class=\"token function\">querySelector</span><span class=\"token punctuation\">(</span><span class=\"token string\">'.chat-text'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>ResizeObserver 观察 <code class=\"language-text\">chat-text</code> 的大小，每次检测到变化时，将 <code class=\"language-text\">chat</code> 滚动到底部。新消息插入时也会触发到resize的检测。</p>\n<p>当用户向上滚动滚动条阅读历史消息时，新消息插入时自动滚动到底部，这会让用户丢掉之前阅读的信息。所以在这里引出一个新问题，如何保留用户的滚动位置？</p>\n<p>我们可以监听scroll事件来判断是否滚动，但是没有API可以区分是scroll事件是用户行为触发还是程序触发，这里hack的方式是使用flag来区分。代码如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">let</span> ro <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ResizeObserver</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">initScrollPositionChat</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">chat</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> chatText <span class=\"token operator\">=</span> chat<span class=\"token punctuation\">.</span>firstElementChild\n\n  chatText<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">resizeHandler</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">entry</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> chat <span class=\"token operator\">=</span> entry<span class=\"token punctuation\">.</span>target<span class=\"token punctuation\">.</span>parentNode<span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// 判断flag</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>chat<span class=\"token punctuation\">.</span>saveUserScroll<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      chat<span class=\"token punctuation\">.</span>isResizeScrollEvent <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n      chat<span class=\"token punctuation\">.</span>scrollTop <span class=\"token operator\">=</span> chat<span class=\"token punctuation\">.</span>scrollHeight <span class=\"token operator\">-</span> chat<span class=\"token punctuation\">.</span>clientHeight<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  ro<span class=\"token punctuation\">.</span><span class=\"token function\">observe</span><span class=\"token punctuation\">(</span>chatText<span class=\"token punctuation\">)</span>\n\n  chat<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'scroll'</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">ev</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Ignore scrolls generated by ResizeObserver</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>chat<span class=\"token punctuation\">.</span>isResizeScrollEvent<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">delete</span> chat<span class=\"token punctuation\">.</span>isResizeScrollEvent<span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// 保存用户的位置，除非已经滚动到底部了</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>chat<span class=\"token punctuation\">.</span>scrollTop <span class=\"token operator\">!=</span> chat<span class=\"token punctuation\">.</span>scrollHeight <span class=\"token operator\">-</span> chat<span class=\"token punctuation\">.</span>clientHeight<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      chat<span class=\"token punctuation\">.</span>saveUserScroll <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      chat<span class=\"token punctuation\">.</span>saveUserScroll <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Resize Observer API目前还有很多特性处于草稿阶段，有兴趣的朋友可以前往<a href=\"https://www.w3.org/TR/resize-observer/#intro\">w3.org</a>查阅</p>\n<h2>三个Observer的对比</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3fde7b6b445b8eb5a773e0f1e520c79b/8ad1b/observers.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 204.43037974683546%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAApCAYAAAA1bQl+AAAACXBIWXMAAAsTAAALEwEAmpwYAAAE0ElEQVRIx41XaXfiOgzt//9178xWYIDsceJ9i0MLM/cdi6W0UKYfdByIuZaurmTxNE2veGjxBTG+0HM8PV9bSq+Xd3l9+ifg9P4HKe0vpriBGA1CBj/tefoK0BnM2QlSOkjpEbSHHhXqikFyc9n79NGDe2Hl0yc/E4jPZgImYeAGibHjCHb6AHgFdn5OVzalPSaXMIUZaT7QATlMySRYx+Hyu2vAeO1hDs3NsBdLcH6HmD00ESHMMMqDdQLeJeLyNinnsMKMKC04k+C9wNgJjL2AYBJxEHDKIWoPxzVYMxBg/n0Iu3uAOawJk/bHLF6HnT9rBzMocG4wdBx12WPsJWLYYbf7Q/J5xyF5mAFtJPCbpLgEyzUkt2hqhufnDaqiQ1X2WK4bcOHo4FtAExAzL6cEXWfZKk9cikGjrges1zWaeiDZWBPvcPgB8MjL2Y6gOQIrLPHaFB34oLDbHW5l8xHwTZdHC34C5wLa+Pe6/SD+fwJ662CUgDcCZdlACEO6PL+/1m/8Z8gUpsUUsw4DjFJQUiHG3U1ZfslD2hQCUjpgSgfMu7+wSkJwcQN4tgeA+fsJ0TlY48mCNXBqQFl1UOook4+g72qZ6tWcdJiFHicEw6GlhlYGXo8IugcfR3ibk7O/9fBNvLlSIoJkGNgA1g+wokUKBvMOmOc/FLKRAkVRUxu7152ejk3zlXhKMVISjpWSa9vDKYa+52BsxDAICM7JQ2f9RfRnaZGH87wHYwOapoUPFiGcQiEqEoLVsMZRIqqyQlM3aJuWDuG5FKWBVg5aO2oSFw/ntIePCSZn9QI4YwrxmF1tUFUtNpsSv9cFFsvfWK02WK7WKMsaWuljyJcsxVe4ML0BnvXl3en+GLH6XWG1rlBWPbZFh9W6xrbssNm26HrxluVItbq/C+ithVMjjBiwXBV4XqyxLWoILtG1md8RXTdAcHUFGO8DHgnfIQUHLRgWyy2Wqw2+/1jg2/cFlWIGzFQIoamJPAQ8dpyjArTkxNtyucZmUxBvfcfQNh3quqWkvd0pn3l4ucz3VClV3aPtBlRVByk0nAvQ2sJoB2fDFzy8Eq7UHh0TEMqRcWlpzfxfX1R3AacLhy8Q2kIYg1EptIzDhxlzOtwMAu+6zT1AynBM8CGRpJTxYFxhzEK2EfcGhAeAx80uJjApCWjgCtoFcGVQNgxKB/iwewf2AfAobBviaRg6ELgJHvN8oGpyfoJQBsZFcGlg3XTTF2881N7R5OD9DOUtBiUxCgNhHJRWqJse3SjBRk1ePgDM88oMYQ26QaAfBVrdw/hInmQutfeou5GynQ/Makgnvj+dvmhT2lMmc/ijVhDKYhAaDRtRtB1Z2WVPBb3LXSac+Hz6bJTLmaXu4wNJpR04VkWNn6stlpsK67JF2TIyriyUCZ9PsJfGEBLRkBPS9CO2VY+iZrT+92OFb7/W+PG8wWJdQWn/BcDsoYtwccK26fBzUeD78xpVO6JsBqy2Da2bsqPKeZtt7gHG10uljFaiZgN58nO5xaZsUbUDGsapeup+pIMfDu2XxjAdEKYZVcfwa1ng16qgUJ9XJTom0TKBtueX6nkY8tuN+IKqGyjc7OFyXaEfFVn2NIM+TMq9fwDZg9xdpPK0upDIskadT6SEDPg/96M+qYoH5U8AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Observer.png\"\n        title=\"Observer.png\"\n        src=\"/static/3fde7b6b445b8eb5a773e0f1e520c79b/f058b/observers.png\"\n        srcset=\"/static/3fde7b6b445b8eb5a773e0f1e520c79b/c26ae/observers.png 158w,\n/static/3fde7b6b445b8eb5a773e0f1e520c79b/6bdcf/observers.png 315w,\n/static/3fde7b6b445b8eb5a773e0f1e520c79b/f058b/observers.png 630w,\n/static/3fde7b6b445b8eb5a773e0f1e520c79b/40601/observers.png 945w,\n/static/3fde7b6b445b8eb5a773e0f1e520c79b/78612/observers.png 1260w,\n/static/3fde7b6b445b8eb5a773e0f1e520c79b/8ad1b/observers.png 2320w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h2>参考</h2>\n<ol>\n<li><a href=\"https://developers.google.com/web/updates/2016/04/intersectionobserver\">IntersectionObserver’s Coming into View</a></li>\n<li><a href=\"https://github.com/w3c/IntersectionObserver/blob/master/explainer.md\">IntersectionObserver explainer</a></li>\n<li><a href=\"https://web.dev/resize-observer/\">ResizeObserver: it’s like document.onresize for elements</a></li>\n</ol>","frontmatter":{"title":"IntersectionObserver、MutationObserver和ResizeObserver","date":"July 13, 2019","description":null,"categories":[],"tags":[]}},"previous":{"fields":{"slug":"/blogs/再谈EventLoop/"},"frontmatter":{"title":"再谈EventLoop"}},"next":{"fields":{"slug":"/blogs/从getBoundingClientRect到Intersection Observer/"},"frontmatter":{"title":"从getBoundingClientRect到Intersection Observer","draft":false,"tags":[],"categories":[],"status":"publish"}}},"pageContext":{"id":"3be25867-f9aa-547c-997a-4cf93622625c","previousPostId":"c2d36c4a-0402-57e6-9d97-817e50380284","nextPostId":"df83c933-57f4-54d5-a185-8aa110763e95"}},
    "staticQueryHashes": ["2841359383"]}