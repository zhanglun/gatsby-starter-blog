{
    "componentChunkName": "component---src-templates-blog-post-js",
    "path": "/blogs/2019-01-26-巧用-webpack-loader-实现项目的定制化/",
    "result": {"data":{"site":{"siteMetadata":{"title":"张小伦的网络日志","description":"欢迎来到张小伦的网络日志 \n\t\t一个记录生活，分享心得的博客","menu":[{"id":"home","name":"首页","url":"/"},{"id":"category","name":"分类","url":"/categories"},{"id":"archive","name":"归档","url":"/archives"},{"id":"about","name":"关于我","url":"/about"}]}},"markdownRemark":{"id":"b448a0d9-ef80-57dc-ac0f-bc89aeacf5c5","html":"<h2>背景</h2>\n<p>有这样的需求：项目交付的版本要求支持针对客户定制产品的LOGO、登录界面的背景。</p>\n<!--more--> \n<h2>简单分析</h2>\n<p>手动替换文件再编译这种蠢到极点的方法肯定是无法接受的。如果你说采用分支的方式来对付这种需求，我觉得也是不太现实。分支虽然好用，但是不要瞎用。项目在交付时需要避免交付的代码中包含其他客户的资源和信息。这意味着，通过配置文件等在运行时加载的形式是行不通。</p>\n<p>想来想去，问题的本质无非就是解决项目编译输出时CSS可以使用我们指定的图片文件，而我们需要将这个过程自动化。</p>\n<h2>粗暴的方案</h2>\n<p>先来一种简单而又直接的方案：直接替换。其步骤如下：</p>\n<ol>\n<li>将图片资源放入指定的目录中，按项目(客户)区分</li>\n<li>执行替换图片资源的脚本，使用指定的资源替换</li>\n<li>执行项目的编译命令</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// node ./pre-packaging.js it</span>\n\n<span class=\"token keyword\">const</span> path <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"path\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> fs <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"fs\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> project <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>argv<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> distPath <span class=\"token operator\">=</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"./src/static/images\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 源代码目录</span>\n<span class=\"token keyword\">const</span> resourcePath <span class=\"token operator\">=</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"./resources\"</span><span class=\"token punctuation\">,</span> project<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 项目静态文件目录</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">copyDir</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">src<span class=\"token punctuation\">,</span> dist</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    fs<span class=\"token punctuation\">.</span><span class=\"token function\">accessSync</span><span class=\"token punctuation\">(</span>dist<span class=\"token punctuation\">,</span> fs<span class=\"token punctuation\">.</span>constants<span class=\"token punctuation\">.</span><span class=\"token constant\">R_OK</span> <span class=\"token operator\">|</span> fs<span class=\"token punctuation\">.</span>constants<span class=\"token punctuation\">.</span><span class=\"token constant\">W_OK</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    fs<span class=\"token punctuation\">.</span><span class=\"token function\">mkdirSync</span><span class=\"token punctuation\">(</span>dist<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">copyFile</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">src<span class=\"token punctuation\">,</span> dist</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    fs<span class=\"token punctuation\">.</span><span class=\"token function\">createReadStream</span><span class=\"token punctuation\">(</span>src<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">pipe</span><span class=\"token punctuation\">(</span>fs<span class=\"token punctuation\">.</span><span class=\"token function\">createWriteStream</span><span class=\"token punctuation\">(</span>dist<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> dirList <span class=\"token operator\">=</span> fs<span class=\"token punctuation\">.</span><span class=\"token function\">readdirSync</span><span class=\"token punctuation\">(</span>src<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  dirList<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">item</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> currentPath <span class=\"token operator\">=</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>src<span class=\"token punctuation\">,</span> item<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> currentDistPath <span class=\"token operator\">=</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>dist<span class=\"token punctuation\">,</span> item<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fs<span class=\"token punctuation\">.</span><span class=\"token function\">statSync</span><span class=\"token punctuation\">(</span>currentPath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isDirectory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">copyDir</span><span class=\"token punctuation\">(</span>currentPath<span class=\"token punctuation\">,</span> currentDistPath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> src <span class=\"token operator\">=</span> currentPath<span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">const</span> dist <span class=\"token operator\">=</span> currentDistPath<span class=\"token punctuation\">;</span>\n\n      <span class=\"token function\">copyFile</span><span class=\"token punctuation\">(</span>src<span class=\"token punctuation\">,</span> dist<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">copyDir</span><span class=\"token punctuation\">(</span>resourcePath<span class=\"token punctuation\">,</span> distPath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>看起来我们的问题已经得到解决。但是你仔细想想，便会发现，这种简单粗暴的方案存在多个不足之处。</p>\n<ol>\n<li>侵入性强。每次自定义版本构建之后都修改项目中的图片资源，这些修改很容易被同步到远端。</li>\n<li>拓展性差。自定义的图片资源必须严格按照源码中的约定，比如图片格式，图片尺寸。每一张图片都需要在代码中提供相应的插槽。</li>\n<li>功能单一。只能修改图片的引用，当其他的样式需要调整时便无能为力。</li>\n<li>体验性差。将构建过程拆分为准备静态资源和编译两个过程。</li>\n</ol>\n<h2>我们需要优雅</h2>\n<p>如此丑陋的方案是无法接受的，是否有更好的方案？此时我们回到问题：如何实现同一个项目针对不同客户定制界面的Logo和登录背景？</p>\n<p>我们需要修改的是什么？CSS!</p>\n<p>既想修改CSS样式，又想不对源码进行修改，那只有采用CSS样式具有的覆盖规则来实现。源文件中设置默认样式，约定使用的 CSS 选择器，通过编译将新的样式文件和源文件合并，所有的样式打包输出。这种方式有诸多好处：</p>\n<ol>\n<li>侵入性弱。只需要在项目仓库中维护对应的资源，不影响源代码，交付时也不会包含多余的资源。</li>\n<li>拓展性强。自定义的图片资源不在依赖源码，可以使用任意的图片格式。</li>\n<li>功能丰富。可以额外增加自定义样式，不限于需求中的Logo和背景。</li>\n<li>体验好。在编译阶段加载指定的样式，一步到位。</li>\n</ol>\n<p>说到前端的编译打包，自然想到Webpack。可以从 Webpack Loader入手，实现上述过程。</p>\n<h2>Webpack Loader</h2>\n<p>在 Webpack 的生态中，Loader 用于对模块的源代码进行转换。Loader 可以使你在 import 或”加载”模块时预处理文件。因此，Loader 类似于其他构建工具中“任务(task)”，并提供了处理前端构建步骤的强大方法。Loader 可以将文件从不同的语言（如 TypeScript）转换为 JavaScript，或将内联图像转换为 data URL。</p>\n<p>Webpack Loader的编写可参考<a href=\"https://webpack.docschina.org/contribute/writing-a-loader/\">官方文档</a>，有非常详细的说明。</p>\n<p>以常见的一段 Webpack 配置为例：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">module<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  entry<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token operator\">...</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  output<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token operator\">...</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  module<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    rules<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token operator\">...</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">{</span>\n        test<span class=\"token operator\">:</span> <span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">\\.less$</span><span class=\"token regex-delimiter\">/</span></span><span class=\"token punctuation\">,</span>\n        use<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n          <span class=\"token punctuation\">{</span>\n            loader<span class=\"token operator\">:</span> <span class=\"token string\">'style-loader'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n          <span class=\"token punctuation\">{</span>\n            loader<span class=\"token operator\">:</span> <span class=\"token string\">'css-loader'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n          <span class=\"token punctuation\">{</span>\n            loader<span class=\"token operator\">:</span> <span class=\"token string\">'less-loader'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token operator\">...</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>上述配置在执行过程中，less文件的编译会按照如下顺序 (<a href=\"https://webpack.docschina.org/contribute/writing-a-loader/#%E5%A4%8D%E6%9D%82%E7%94%A8%E6%B3%95\">Webpack Loader 执行顺序</a>)：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/95c0e8c459b471e82c5a05cef9bf673b/31493/1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 12.658227848101264%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA/klEQVQI1wHzAAz/AJzMXWd4zpcAPry0W2HQxZpi0caHXc7Ekj69tkkAAAACUce/jWLQxplj0ceVT8a+mQCMggg9vLZBXM3EpGLQxphgz8WrQL62bXTOnQCdzV5TAJ3MXOQALP8GVcbDmorQv/+HzLz/gMy9/13LxYwAmOAcetLE/43SwP+Jy7r/etHD/wCx3h5Pw8V/hM29/4rPvv+Kzr3/YMnApwAA/wKXymDfAJrKXYO33HIAP7y3cGjKvtJoyb25Yca8x0TAvFAAlr0NVsW8v2jKvsppyb3OWca91garvBY7u7lMX8a7xmbIvbdlyL3JQby2ervZZgCWxl55ML2MMRnMH9gAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"IMAGE\"\n        title=\"IMAGE\"\n        src=\"/static/95c0e8c459b471e82c5a05cef9bf673b/f058b/1.png\"\n        srcset=\"/static/95c0e8c459b471e82c5a05cef9bf673b/c26ae/1.png 158w,\n/static/95c0e8c459b471e82c5a05cef9bf673b/6bdcf/1.png 315w,\n/static/95c0e8c459b471e82c5a05cef9bf673b/f058b/1.png 630w,\n/static/95c0e8c459b471e82c5a05cef9bf673b/31493/1.png 664w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>在整个编译过程中，我们可以在每一个loader的开始前和结束后合并我们自定义样式，如下图所示：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f979da3bd447384b9ffb01db20e93b14/7608e/2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 25.316455696202528%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAABoElEQVQY0wGVAWr+ADu+tx5rzsLuds7A63bPwvNky8C6RsG7VnjWyNV20sXGd9XI2VXHv2tcysGDd9XI13bTxcd01cjNMbezSXHUx7J41cfSetXH1WbPw8AJoqENAD7FxhNw0MTSe87A3HzPweJqy7+mWMnAYoXczf57z8Hsg9nK+2HNwntq0MWYg9nK/3jPxPiB28z9OLm1WoDbzNGC1cf1gtTF9XLVytkDo60PAFu4gQVCsW8QAKb/CwCiqwcAX4sFAJKmCwCIlA0Gt9oVAImVCwCHnQkAmKYNAKCmDxW82hgApKYTAKa0DQCWmw0Er8cWALD/CEq0gxZfuYgGAKDOWrqj0FnfRrGeHjC6yjp10MLXftLD12fMwKsAQ/8IX8rEfXzTxN970cPdW8nBbgBp/Q1rzMG4f9PE4XLOwNwguNgzZbeCIKTQWOOgzlqsAJvIV86cy1nxXbeIFjC7zDtuyLz3dsi69mLHvb3//xAAV8bAl3XKvP10ybz/VsbAiwAA/wNjxbzJd8m68WjFufAnvNgsbLt/I5vJWP2dyli21TPm4Z6jEAYAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"IMAGE\"\n        title=\"IMAGE\"\n        src=\"/static/f979da3bd447384b9ffb01db20e93b14/f058b/2.png\"\n        srcset=\"/static/f979da3bd447384b9ffb01db20e93b14/c26ae/2.png 158w,\n/static/f979da3bd447384b9ffb01db20e93b14/6bdcf/2.png 315w,\n/static/f979da3bd447384b9ffb01db20e93b14/f058b/2.png 630w,\n/static/f979da3bd447384b9ffb01db20e93b14/7608e/2.png 735w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>在less-loader之前加入自定义的CSS样式是最好的时机，为什么呢？有两点：</p>\n<ol>\n<li>同时支持原生 CSS 和 Less 两种文件。</li>\n<li>在整个编译开始之前加入，对编译的整个过程没有影响。新增的样式同样享受完整编译过程。</li>\n</ol>\n<p>编译过程修改为如下图所示：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e7cbc41db84c64824a6fd351eb1e7592/6a6e9/3.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 10.126582278481013%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAAAsTAAALEwEAmpwYAAAArUlEQVQI1wGiAF3/AKDOWqmiz1nBE6q+EWfMwbV80sTZYsi+kiq4wiZtzMDTec/B2VTEvmxKxMJKedLE1nfRw889vrxAW8fAcXrSxNJtzsHABazaGKLPWI+gz1rMAJrIWLydylfLGLjRGGLCubp3x7ngX8G4mSW6yyZtyb3Resy+2FXEv2JHwcFXeMy+53bLveg8v8FOWsK9f3rKu+1rx7rYB7TrHZrHV62dy1jqwINhtpg5mDIAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"IMAGE\"\n        title=\"IMAGE\"\n        src=\"/static/e7cbc41db84c64824a6fd351eb1e7592/f058b/3.png\"\n        srcset=\"/static/e7cbc41db84c64824a6fd351eb1e7592/c26ae/3.png 158w,\n/static/e7cbc41db84c64824a6fd351eb1e7592/6bdcf/3.png 315w,\n/static/e7cbc41db84c64824a6fd351eb1e7592/f058b/3.png 630w,\n/static/e7cbc41db84c64824a6fd351eb1e7592/6a6e9/3.png 826w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h2>开发一个 merge-loader</h2>\n<p>在目前的场景中，merge-loader 只需要一个参数：自定义样式的文件路径。所以 Webpack 配置文件可以修改为：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">module<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  entry<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token operator\">...</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  output<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token operator\">...</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  module<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    rules<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token operator\">...</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">{</span>\n        test<span class=\"token operator\">:</span> <span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">\\.less$</span><span class=\"token regex-delimiter\">/</span></span><span class=\"token punctuation\">,</span>\n        use<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n          <span class=\"token punctuation\">{</span>\n            loader<span class=\"token operator\">:</span> <span class=\"token string\">'style-loader'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n          <span class=\"token punctuation\">{</span>\n            loader<span class=\"token operator\">:</span> <span class=\"token string\">'css-loader'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n          <span class=\"token punctuation\">{</span>\n            loader<span class=\"token operator\">:</span> <span class=\"token string\">'less-loader'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token punctuation\">}</span>，\n          <span class=\"token punctuation\">{</span>\n            loader<span class=\"token operator\">:</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>__dirname<span class=\"token punctuation\">,</span> <span class=\"token string\">'./loader/merge-less.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 自定义loader文件的路径</span>\n            options<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n              style<span class=\"token operator\">:</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">,</span> <span class=\"token string\">'client/statics/projects/it/style.less'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token operator\">...</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>merge-loader中的逻辑如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> getOptions <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'loader-utils'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nmodule<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">exports</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">source</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> options <span class=\"token operator\">=</span> <span class=\"token function\">getOptions</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> style <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> options<span class=\"token punctuation\">;</span>\n  \n  <span class=\"token comment\">// 读取样式文件，返回字符串</span>\n  <span class=\"token keyword\">const</span> string <span class=\"token operator\">=</span> fs<span class=\"token punctuation\">.</span><span class=\"token function\">readFileSync</span><span class=\"token punctuation\">(</span>style<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// 合并到原始文件，返回给下一个loader</span>\n  source <span class=\"token operator\">+=</span> string<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> source<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>你以为这样就结束了？不，上述逻辑有两个问题还需优化：</p>\n<ol>\n<li>当样式中存在图片的引用时，以字符串形式拼接在源码样式中会遇到图片路径错误的问题</li>\n<li>只要文件通过了规则<code class=\"language-text\">/\\.less&amp;/</code>的匹配，就会执行一次merge操作。含有<code class=\"language-text\">&lt;style lang=\"less\">&lt;/style></code> 的vue文件也会触发这个规则(虽然重复引用不会增加代码量)。</li>\n</ol>\n<p>这两个问题的解法如下：</p>\n<ol>\n<li>使用 <code class=\"language-text\">@import \"path/of/style\"</code> 方式 merge 样式文件。其他的处理交给后面的loader，保证文件和图片路径引用正确。</li>\n<li>增加一个参数<code class=\"language-text\">target</code>，指定一个文件作为 merge 的对象。</li>\n</ol>\n<p>这样一来，loader的逻辑修改如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> getOptions <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'loader-utils'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nmodule<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">exports</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">source， meta</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> options <span class=\"token operator\">=</span> <span class=\"token function\">getOptions</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> style<span class=\"token punctuation\">,</span> target <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> options<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>meta<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// file: 'test.vue'</span>\n    <span class=\"token comment\">// sourceRoot: 'client'</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> file<span class=\"token punctuation\">,</span> sourceRoot <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> meta<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>target <span class=\"token operator\">===</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span>sourceRoot<span class=\"token punctuation\">,</span> file<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> string <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">\\n@import \"</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>style<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">\";\\n</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n      \n      source <span class=\"token operator\">+=</span> string<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> source<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Webpack 配置文件中loader部分修改如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">module<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  entry<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token operator\">...</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  output<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token operator\">...</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  module<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    rules<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token operator\">...</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">{</span>\n        test<span class=\"token operator\">:</span> <span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">\\.less$</span><span class=\"token regex-delimiter\">/</span></span><span class=\"token punctuation\">,</span>\n        use<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n          <span class=\"token punctuation\">{</span>\n            loader<span class=\"token operator\">:</span> <span class=\"token string\">'style-loader'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n          <span class=\"token punctuation\">{</span>\n            loader<span class=\"token operator\">:</span> <span class=\"token string\">'css-loader'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n          <span class=\"token punctuation\">{</span>\n            loader<span class=\"token operator\">:</span> <span class=\"token string\">'less-loader'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token punctuation\">}</span>，\n          <span class=\"token punctuation\">{</span>\n            loader<span class=\"token operator\">:</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>__dirname<span class=\"token punctuation\">,</span> <span class=\"token string\">'./loader/merge-less.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 自定义loader文件的路径</span>\n            options<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n              style<span class=\"token operator\">:</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">,</span> <span class=\"token string\">'client/statics/projects/it/style.less'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token operator\">...</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2>优化 Loader</h2>\n<p>最后利用 <a href=\"https://webpack.docschina.org/contribute/writing-a-loader/#loader-%E5%B7%A5%E5%85%B7%E5%BA%93-loader-utilities-\">Loader 工具库</a>来优化代码</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> fs <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fs'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> path <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'path'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> loaderUtils <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'loader-utils'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> validateOptions <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'schema-utils'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> schema <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  type<span class=\"token operator\">:</span> <span class=\"token string\">'object'</span><span class=\"token punctuation\">,</span>\n  properties<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    style<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      type<span class=\"token operator\">:</span> <span class=\"token string\">'string'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    target<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      type<span class=\"token operator\">:</span> <span class=\"token string\">'string'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  required<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">'style'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'target'</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n\nmodule<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">exports</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">source<span class=\"token punctuation\">,</span> meta</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> options <span class=\"token operator\">=</span> loaderUtils<span class=\"token punctuation\">.</span><span class=\"token function\">getOptions</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// 验证 options 参数</span>\n  <span class=\"token function\">validateOptions</span><span class=\"token punctuation\">(</span>schema<span class=\"token punctuation\">,</span> options<span class=\"token punctuation\">,</span> <span class=\"token string\">'Loader options'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">let</span> <span class=\"token punctuation\">{</span> style<span class=\"token punctuation\">,</span> target <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> options<span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">/*\n   * Loader 原则之一：不要在模块代码中插入绝对路径，因为当项目根路径变化时，文件绝对路径也会变化\n   * 使用 stringifyReques 将绝对路径转换成相对路径\n   */</span>\n  style <span class=\"token operator\">=</span> loaderUtils<span class=\"token punctuation\">.</span><span class=\"token function\">stringifyRequest</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> style<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>meta<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> file<span class=\"token punctuation\">,</span> sourceRoot <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> meta<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>target <span class=\"token operator\">===</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span>sourceRoot<span class=\"token punctuation\">,</span> file<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> string <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">\\n @import </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>style<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">;\\n</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n\n      source <span class=\"token operator\">+=</span> string<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> source<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>结束</h2>\n<p>至此，已经用一种比较优雅的方式实现了项目Logo等样式的定制化，其优势在于：</p>\n<ol>\n<li>侵入性弱。只需要在项目仓库中维护对应的资源，不影响源代码，交付时也不会包含多余的资源。</li>\n<li>拓展性强。自定义的图片资源不在依赖源码，可以使用任意的图片格式。</li>\n<li>功能丰富。可以额外增加自定义样式，不限于需求中的Logo和背景。</li>\n<li>体验好。在编译阶段加载指定的样式，一步到位。</li>\n</ol>\n<p>如果同学们有其他的实现方式，欢迎讨论~~</p>","frontmatter":{"title":"巧用 webpack loader 实现项目的定制化","date":"January 26, 2019","description":null,"categories":["技术应用"],"tags":["Webpack"]}},"previous":{"fields":{"slug":"/blogs/2019-03-09-浅谈-HTTP-缓存/"},"frontmatter":{"title":"浅谈 HTTP 缓存"}},"next":{"fields":{"slug":"/blogs/2018-10-08-在CentOS上部署Pyspider爬虫项目/"},"frontmatter":{"title":"在 CentOS 上部署 pyspider 爬虫项目","draft":null,"tags":["Python"],"categories":[null],"status":"publish"}}},"pageContext":{"id":"b448a0d9-ef80-57dc-ac0f-bc89aeacf5c5","previousPostId":"2f25d64b-dc5e-5051-80b1-6650d598731b","nextPostId":"299b7724-70ec-5fd6-8938-26d6bf535bf8"}},
    "staticQueryHashes": ["2841359383"]}